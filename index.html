<!DOCTYPE html>
<html>

<head>
	<title>PhysicsSim</title>
	<link href='favicon.ico' rel='icon'>
</head>

<body>

<canvas id="myCanvas" style="border:2px solid"></canvas>

<script>
	// vector math -------------------------------------------------------

	class Vector2 {
		constructor(x = 0.0, y = 0.0) {
			this.x = x; 
			this.y = y;
		}

		set(v) {
			this.x = v.x; this.y = v.y;
		}

		clone() {
			return new Vector2(this.x, this.y);
		}

		// these 4 change this vector and return it
		add(v, s = 1.0) {
			this.x += v.x * s;
			this.y += v.y * s;
			return this;
		}

		sub(v, s = 1.0) {
			this.x -= v.x * s;
			this.y -= v.y * s;
			return this;
		}

		scale(s) {
			this.x *= s;
			this.y *= s;
			return this;
		}

		div(s) {
			this.x /= s;
			this.y /= s;
			return this;
		}

		// these 4 don't change this vector, but only return the result
		plus(other){
			return new Vector2(this.x+other.x,this.y+other.y);
		}

		minus(other) {
			return new Vector2(this.x-other.x,this.y-other.y);
		}

		times(scalar){
			return new Vector2(this.x*scalar,this.y*scalar);
		}
		
		divide(scalar){
			return new Vector2(this.x/scalar,this.y/scalar);
		}


		length() {
			return Math.sqrt(this.x * this.x + this.y * this.y);
		}

		dot(v) {
			return this.x * v.x + this.y * v.y;
		}

		perp() {
			return new Vector2(-this.y, this.x);
		}		
	}

	// canvas setup -------------------------------------------------------

	{
		var canvas = document.getElementById("myCanvas");
		var c = canvas.getContext("2d");

		canvas.width = window.innerWidth - 20;
		canvas.height = window.innerHeight - 100;

		var simMinWidth = 20.0;
		var cScale = Math.min(canvas.width, canvas.height) / simMinWidth;
		var simWidth = canvas.width / cScale;
		var simHeight = canvas.height / cScale;

		function cX(pos) {
			return pos.x * cScale;
		}

		function cY(pos) {
			return canvas.height - pos.y * cScale;
		}
	}
	
	// physics classes ------------------------------------------------------------

	class Particle {
        constructor(mass, radius, pos, vel, acc=new Vector2(0.0, 0.0), restitution=0.2) {
            this.radius = radius;
			this.mass = mass;
			this.restitution = restitution;
			this.pos = pos.clone();
			this.vel = vel.clone();
			this.acc = acc.clone();
			this.previous_pos = pos.clone();
        }
        simulate(dt, method = 'euler-cromer') 
        {
			switch(method){
				case 'euler-cromer':
					// euler-cromer update
					this.vel.add(this.acc, dt);
					this.pos.add(this.vel, dt);
					break;
				
				case 'euler':
					// euler update
					this.pos.add(this.vel, dt);
					this.vel.add(this.acc, dt);
					break;

				case 'verlet': 
					// verlet update
					var pt = this.pos.clone();
					this.pos = this.pos.times(2.0).minus(this.previous_pos).add(this.acc,dt**2);
					this.previous_pos = pt.clone();
					this.vel = this.pos.minus(this.previous_pos).divide(dt);
					break;
			}
			
			if (this.pos.x < 0.0) {
				this.pos.x = 0.0;
				this.vel.x = -this.vel.x;
			}
			if (this.pos.x > simWidth) {
				this.pos.x = simWidth;
				this.vel.x = -this.vel.x;
			}
			if (this.pos.y < 0.0) {
				this.pos.y = 0.0;
				this.vel.y = -this.vel.y;
			}
			if (this.pos.y > simHeight) {
				this.pos.y = simHeight;
				this.vel.y = -this.vel.y;
			}
        }
        draw() {
            c.beginPath();			
			c.arc(
				cX(this.pos), cY(this.pos), cScale * this.radius, 0.0, 2.0 * Math.PI); 
			c.closePath();
			c.fill();
        }
    }

	class FixedSpring {
		constructor(point, particle, stiffness=1.0, damping_par=1.0){
			this.particle = particle;
			this.point = point;
			this.stiffness = stiffness;
			this.damping_par = damping_par;
			this.length = point.minus(particle.pos).length();
		}
		simulate(){
			var relative_pos = this.point.minus(this.particle.pos);
			var actual_length = relative_pos.length();
			var normalized_dir = relative_pos.divide(actual_length);
			var relative_vel = new Vector2(0.0, 0.0).minus(this.particle.vel);

			var elastic_gen = this.stiffness/this.length * (actual_length - this.length);
			var damping_gen = relative_vel.dot(normalized_dir) * this.damping_par;
			
			var elastic = normalized_dir.times(1/this.particle.mass * elastic_gen);
    		var damping = normalized_dir.times(damping_gen * 1/this.particle.mass);

			var acc_particle = elastic.add(damping);

			this.particle.acc.add(acc_particle);
		}
		draw(){
			c.beginPath();
			c.moveTo(cX(this.particle.pos), cY(this.particle.pos));
			c.lineTo(cX(this.point), cY(this.point));
			c.stroke();

			// draw point
			c.beginPath();			
			c.arc(
				cX(this.point), cY(this.point), cScale * 0.1, 0.0, 2.0 * Math.PI); 
			c.closePath();
			c.fill();
		}
	}

	class Spring {
		constructor(particle1, particle2, stiffness=1.0, damping_par = 1.0){
			this.particle1 = particle1;
			this.particle2 = particle2;
			this.stiffness = stiffness;
			this.damping_par = damping_par;
			this.length = particle2.pos.minus(particle1.pos).length();
		}
		simulate(){
			var relative_pos = this.particle2.pos.minus(this.particle1.pos);
			var actual_length = relative_pos.length();
			var normalized_dir1 = relative_pos.divide(actual_length);
			var normalized_dir2 = relative_pos.divide(actual_length).times(-1.0);
			var relative_vel = this.particle2.vel.minus(this.particle1.vel);

			var elastic_gen = this.stiffness/this.length * (actual_length - this.length);
			var damping_gen = relative_vel.dot(normalized_dir1) * this.damping_par;

			var acc_particle1 = normalized_dir1.times(1/this.particle1.mass * elastic_gen).add(normalized_dir1.times(damping_gen * 1/this.particle1.mass));
			var acc_particle2 = normalized_dir2.times(1/this.particle2.mass * elastic_gen).add(normalized_dir2.times(damping_gen * 1/this.particle2.mass));


			this.particle1.acc.add(acc_particle1);
			this.particle2.acc.add(acc_particle2);
		}
		draw(){
			c.beginPath();
			c.moveTo(cX(this.particle1.pos), cY(this.particle1.pos));
			c.lineTo(cX(this.particle2.pos), cY(this.particle2.pos));

			c.stroke();
		}
	}

	// physical objects -----------------------------------------------------------

	class ElasticSquare {
		constructor(side_length,pos=[1,1],scale=1.5,stiffness=20000.0,damping_par=10.0){
			this.particles = [];
			this.springs = [];
			this.stiffness = stiffness;
			this.damping_par = damping_par;

			// setup particles
			for (var x = pos[0]; x < pos[0]+side_length; x++){
				for (var y = pos[1]; y < pos[1]+side_length; y++){
					var ges = (y>pos[1]+side_length/2 && x>pos[0]+side_length/2)? new Vector2(10.0, 30.0):new Vector2(-10.0,30.0);
					this.particles.push(new Particle(10, 0.1, new Vector2(x*scale, y*scale), ges));
				}
			}

			// connect with springs
			this.connect_to_quader(0,side_length,side_length+1,1);

			for (var i = 1; i < side_length-1; i++){
				this.connect_to_quader(side_length*i,side_length+side_length*i,side_length+1+side_length*i,1+side_length*i, true);
				this.connect_to_quader(i,side_length+i,side_length+1+i,1+i,false,true);
			}

			for (var i = 1; i < side_length-1; i++){
				for (var j = 1; j < side_length-1; j++){
					this.connect_to_quader(side_length*i+j,side_length+side_length*i+j,side_length+1+side_length*i+j,1+side_length*i+j,true,true);
				}
			}
		}

		connect_to_quader(a,s,d,f,no_left=false,no_up=false){
			if(!no_up){
				this.springs.push(new Spring(this.particles[a], this.particles[s], this.stiffness, this.damping_par));
			}

			this.springs.push(new Spring(this.particles[s], this.particles[d], this.stiffness, this.damping_par));
			this.springs.push(new Spring(this.particles[d], this.particles[f], this.stiffness, this.damping_par));

			if (!no_left){
				this.springs.push(new Spring(this.particles[f], this.particles[a], this.stiffness, this.damping_par));
			}
			//diagonals
			this.springs.push(new Spring(this.particles[a], this.particles[d], this.stiffness, this.damping_par));
			this.springs.push(new Spring(this.particles[s], this.particles[f], this.stiffness, this.damping_par));

			//this.springs.push.apply(this.springs,springs);
		}

		simulate(gravity,dt,method='verlet'){
			for (var i = 0; i < this.particles.length; i++){
				this.particles[i].acc = new Vector2(0,0);			//reset acc
				this.particles[i].acc.add(gravity);	//add gravity
			}
			
			for (var i = 0; i < this.springs.length; i++){
				this.springs[i].simulate();		//add spring accelaration
			}

			for (var i = 0; i < this.particles.length; i++){
				this.particles[i].simulate(dt, method);	//simulate particles using specified method
			}
		}

		draw(){
			for (var i = 0; i < this.particles.length; i++) {
				this.particles[i].draw();
			}

			for (var i = 0; i < this.springs.length; i++) {
				this.springs[i].draw();
			}
		}
	}
	
	// scene -------------------------------------------------------

	var scene = {
		gravity : new Vector2(0.0, -10.0),
		dt : 1.0 / 60.0,
		particles : [],
		springs : [],
		objects : []
    };

	function setup_scene(){
		var num = 0
		// Setup Particles
		{	
			scene.particles = [];

			// Chaos Pendulum Particles
			{
				scene.particles.push(new Particle(50, 0.5, new Vector2(15.0, 17.0), new Vector2(5.0, 0.0)));
				scene.particles.push(new Particle(40, 0.4, new Vector2(16.0, 19.0), new Vector2(15.0, 0.0)));
				scene.particles.push(new Particle(30, 0.3, new Vector2(18.0, 20.0), new Vector2(5.0, 0.0)));
			}

			// Single Quader Particles
			{
				scene.particles.push(new Particle(10, 0.2, new Vector2(20.0, 25.0), new Vector2(20.0, 10.0)));
				scene.particles.push(new Particle(10, 0.2, new Vector2(15.0, 20.0), new Vector2(4.0, 10.0)));
				scene.particles.push(new Particle(10, 0.2, new Vector2(20.0, 15.0), new Vector2(4.0, 10.0)));
				scene.particles.push(new Particle(10, 0.2, new Vector2(25.0, 20.0), new Vector2(4.0, 10.0)));
			}
		}

		// Setup Springs
		{	
			scene.springs = [];

			// Chaos Pendulum
			{
				scene.springs.push(new FixedSpring(new Vector2(15.0,15.0), scene.particles[num**2], 50000.0, 1000.0));
				scene.springs.push(new Spring(scene.particles[num**2], scene.particles[num**2+1], 50000.0, 1000.0));
				scene.springs.push(new Spring(scene.particles[num**2+1], scene.particles[num**2+2], 50000.0, 1000.0));
			}

			// Single Quader
			{
				scene.springs.push(new Spring(scene.particles[num**2+3], scene.particles[num**2+4], 10000.0, 10.0));
				scene.springs.push(new Spring(scene.particles[num**2+4], scene.particles[num**2+5], 10000.0, 10.0));
				scene.springs.push(new Spring(scene.particles[num**2+5], scene.particles[num**2+6], 10000.0, 10.0));
				scene.springs.push(new Spring(scene.particles[num**2+6], scene.particles[num**2+3], 10000.0, 10.0));
				//diagonals
				scene.springs.push(new Spring(scene.particles[num**2+3], scene.particles[num**2+5], 10000.0, 10.0));
				scene.springs.push(new Spring(scene.particles[num**2+4], scene.particles[num**2+6], 10000.0, 10.0));
			}
		}

		// Setup Objects
		{
			scene.objects = [];

			scene.objects.push(new ElasticSquare(8,[4,2],1.5,26000,10));
		}
	}

	// drawing -------------------------------------------------------

	function draw() {
		c.clearRect(0, 0, canvas.width, canvas.height);

		c.fillStyle = "#FF0000";

		for (var i = 0; i < scene.objects.length; i++) {
			scene.objects[i].draw();
		}

		for (var i = 0; i < scene.particles.length; i++) {
			scene.particles[i].draw();
		}

		for (var i = 0; i < scene.springs.length; i++) {
			scene.springs[i].draw();
		}
	}

	// simulation ----------------------------------------------------

	function simulate(method = 'verlet') {
		for (var i = 0; i < scene.particles.length; i++){
			scene.particles[i].acc = new Vector2(0,0);			//reset acc
			scene.particles[i].acc.add(scene.gravity);	//add gravity
		}
		
		for (var i = 0; i < scene.objects.length; i++){
			scene.objects[i].simulate(scene.gravity,scene.dt,method);		//add spring accelaration
		}

		for (var i = 0; i < scene.springs.length; i++){
			scene.springs[i].simulate();		//add spring accelaration
		}

		for (var i = 0; i < scene.particles.length; i++){
			scene.particles[i].simulate(scene.dt, method);	//simulate particles using specified method
		}
	}

	// make browser to call us repeatedly -----------------------------------

	function update() {
		simulate();
		draw();
		requestAnimationFrame(update);
	}
	
	setup_scene();
	simulate('euler-cromer');
	update();
	
</script> 
</body>
</html>
